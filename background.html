<!DOCTYPE html>
<html>
  <head>
    <script>

      function matchUrl(tabId, changeInfo, tab)
      {
        switch(urlIsMatching(tab.url))
        {
          case "g":
            showPageActionIcon(tabId, "y", "Search moar!");
            break;

          case "y":
            showPageActionIcon(tabId, "g", "Search moar!");
            break;

          default:
            hidePageActionIcon(tabId);
            break;
        }
      }

      function urlIsMatching(url)
      {
        if(url.match(/^http:\/\/(www\.|images\.)?google\.(com|ru)\/(search|webhp)\?(.*)$/))
        {
          return ((RegExp.$1 == "images.") || isSerpUrl(RegExp.$4)) ? "g" : "";
        }
        else if (url.match(/^http:\/\/(www\.|images\.)?yandex\.ru\/yandsearch\?text=/))
        {
          return "y";
        }
        else
        {
          return "";
        }
      }

      function isSerpUrl(query)
      {
        var sharpPos = query.indexOf("#");
        var params = (sharpPos != -1) ? query.substr(sharpPos + 1) : query;
        var tabParam = "tbm";

        return !containsGetParameter(params, tabParam) || 
                extractGetParameter(params, tabParam) == "isch";
      }

      function containsGetParameter(query, parameterName)
      {
        var param = parameterName + "=";
        return (query.substr(0, param.length) == param) || 
               (query.indexOf("&" + param) != -1);
      }

      function extractGetParameter(query, parameterName)
      {
        var vars = query.split("&"); 
        for (var i = 0; i < vars.length; i++)
        {
          var pair = vars[i].split("="); 
          if (pair[0] == parameterName) return pair[1]; 
        }
        return "";
      }

      function showPageActionIcon(tabId, iconId, title)
      {
        chrome.pageAction.show(tabId);
        console.log("getIconPath()" + getIconPath(iconId));
        chrome.pageAction.setIcon({ tabId: tabId, path: getIconPath(iconId)});
        chrome.pageAction.setTitle({ tabId: tabId, title: title });
      }

      function getIconPath(iconId)
      {
        switch(iconId)
        {
          case "y":
            return "icons/icon-" + iconId + "-18.png";
          case "g":
            return "icons/icon-" + iconId + "-18.png";
          default:
            return "icons/icon-18.png";
        }
      }

      function hidePageActionIcon(tabId)
      {
        chrome.pageAction.hide(tabId);
      }

      function redirectSearchRequest(tab)
      {
        console.log("redirectSearchRequest");
      }

      chrome.tabs.onUpdated.addListener(matchUrl);
      chrome.pageAction.onClicked.addListener(redirectSearchRequest); 

    </script>
  </head>
</html>
